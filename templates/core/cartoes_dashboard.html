{% extends 'base.html' %}
{% load static %}
{% load br_filters %}
{% block title %}Central de Cartões{% endblock %}
{% block content %}
<div class="container-fluid" style="padding: 30px;">
    <h2 class="mb-3"><i class="fas fa-credit-card me-2"></i>Central de Cartões</h2>
    <form method="get" class="row g-2 align-items-end mb-2" style="max-width: 600px;">
        <div class="col-auto">
            <label for="data_inicio" class="form-label mb-0">Data inicial</label>
            <input type="date" class="form-control form-control-sm" id="data_inicio" name="data_inicio" value="{{ request.GET.data_inicio|default:'' }}">
        </div>
        <div class="col-auto">
            <label for="data_fim" class="form-label mb-0">Data final</label>
            <input type="date" class="form-control form-control-sm" id="data_fim" name="data_fim" value="{{ request.GET.data_fim|default:'' }}">
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
            {% if request.GET.data_inicio or request.GET.data_fim %}
                <a href="?" class="btn btn-outline-secondary btn-sm ms-1">Limpar</a>
            {% endif %}
        </div>
    </form>
    <div class="row g-2 align-items-stretch mb-2" style="min-height:220px;">
        <div class="col-lg-3 col-md-12 mb-2 mb-lg-0">
            <div class="card shadow h-100 p-2 d-flex flex-column justify-content-center" style="min-height:220px;">
                <div class="card-body p-2">
                    <h6 class="text-muted mb-1" style="font-size:0.95em;">Limite Total</h6>
                    <h4 class="text-primary mb-2" style="font-size:1.3em;">{{ total_limite|br_currency }}</h4>
                    <h6 class="text-muted mt-2 mb-1" style="font-size:0.95em;">Utilizado</h6>
                    <h4 class="text-danger mb-2" style="font-size:1.3em;">{{ total_utilizado|br_currency }}</h4>
                    <h6 class="text-muted mt-2 mb-1" style="font-size:0.95em;">Disponível</h6>
                    <h4 class="text-success mb-0" style="font-size:1.3em;">{{ total_disponivel|br_currency }}</h4>
                </div>
            </div>
        </div>
        <div class="col-lg-6 col-md-7 mb-2 mb-lg-0">
            <div class="card shadow h-100 p-3 d-flex flex-column justify-content-center" style="min-height:220px;">
                <h6 class="text-muted mb-1" style="font-size:0.95em;">Evolução Temporal dos Gastos</h6>
                <div class="d-flex align-items-center justify-content-between mb-1">
                    <div></div>
                    <div>
                        <button id="linhaPrev" class="btn btn-sm btn-light me-1" title="Meses anteriores"><i class="fas fa-chevron-left"></i></button>
                        <button id="linhaNext" class="btn btn-sm btn-light" title="Meses futuros"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <canvas id="graficoLinhaCartoes" style="height: 140px; max-height: 180px; width:100%;"></canvas>
            </div>
        </div>
        <div class="col-lg-3 col-md-5">
            <div class="card shadow h-100 p-3 d-flex flex-column justify-content-center" style="min-height:220px;">
                <div class="d-flex align-items-center mb-1" style="height: 28px;">
                    <h6 class="text-muted mb-0" style="font-size:0.95em;">Evolução de Gastos com Cartões</h6>
                </div>
                <div class="d-flex flex-row align-items-center justify-content-center flex-grow-1" style="gap: 24px; min-height: 160px; height: 180px;">
                    <div style="width: 180px; display: flex; justify-content: center; align-items: center;">
                        <canvas id="graficoGastosCartoes" style="height: 160px; max-height: 200px; width: 160px; max-width: 200px;"></canvas>
                    </div>
                    <div id="legendaGastosCartoes" class="small legenda-horizontal" style="justify-content: flex-start; margin-left: 0; min-width: 110px; max-width: 150px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    {# Script para o gráfico de gastos dos cartões #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chartGastosCartoes = null;
        document.addEventListener('DOMContentLoaded', function() {
            const labelsGastos = {{ labels|safe }};
            const gastos = {{ gastos|safe }};
            const ctxGastos = document.getElementById('graficoGastosCartoes');
            const legendaDiv = document.getElementById('legendaGastosCartoes');
            const cores = [
                '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1',
                '#fd7e14', '#20c997', '#e83e8c', '#6c757d', '#17a2b8'
            ];
            
            if (ctxGastos && labelsGastos && labelsGastos.length > 0) {
                if (chartGastosCartoes) {
                    chartGastosCartoes.destroy();
                }
                chartGastosCartoes = new Chart(ctxGastos.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: labelsGastos,
                        datasets: [{
                            data: gastos,
                            backgroundColor: cores,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentual = ((context.parsed / total) * 100).toFixed(1);
                                        return context.label + ': R$ ' + context.parsed.toLocaleString('pt-BR', {minimumFractionDigits:2}) + ' (' + percentual + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
                if (legendaDiv) {
                    legendaDiv.innerHTML = labelsGastos.map((label, i) =>
                        `<span class='legenda-item'><span class='legenda-cor' style='background:${cores[i]};'></span>${label}</span>`
                    ).join('');
                }
            }
            const mesesPtBr = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const ctxLinha = document.getElementById('graficoLinhaCartoes');
            const allLinhaLabels = {{ evolucao_labels|safe }};
            const allLinhaValores = {{ evolucao_valores|safe }};
            if (ctxLinha && allLinhaLabels && allLinhaLabels.length > 0) {
                let linhaStartIdx = Math.max(0, allLinhaLabels.length - 6 - 3);
                let linhaEndIdx = Math.min(allLinhaLabels.length, linhaStartIdx + 9);
                function renderLinhaChart() {
                    const labels = allLinhaLabels.slice(linhaStartIdx, linhaEndIdx);
                    const valores = allLinhaValores.slice(linhaStartIdx, linhaEndIdx);
                    if (window.linhaChart) window.linhaChart.destroy();
                    window.linhaChart = new Chart(ctxLinha.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Gastos Mensais',
                                data: valores,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0,123,255,0.1)',
                                tension: 0.3,
                                pointRadius: 3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                x: { grid: { display: false } },
                                y: { beginAtZero: true, grid: { color: '#eee' } }
                            }
                        }
                    });
                }
                renderLinhaChart();
                document.getElementById('linhaPrev').onclick = function() {
                    if (linhaStartIdx > 0) {
                        linhaStartIdx--;
                        linhaEndIdx--;
                        renderLinhaChart();
                    }
                };
                document.getElementById('linhaNext').onclick = function() {
                    if (linhaEndIdx < allLinhaLabels.length) {
                        linhaStartIdx++;
                        linhaEndIdx++;
                        renderLinhaChart();
                    }
                };
            }
        });
    </script>
    <h4 class="mb-3"><i class="fas fa-credit-card me-2"></i>Cartões Cadastrados</h4>
    <div class="wallet-carrossel position-relative mb-4" style="height: 220px;">
      <div class="wallet-cards d-flex align-items-center justify-content-center position-relative" id="walletCards">
        {% for cartao in cartoes %}
          <div class="wallet-card-container position-absolute" data-index="{{ forloop.counter0 }}" style="transition: all 0.4s cubic-bezier(.4,2,.6,1);">
            <div class="cartao-card wallet-card{% if cartao_selecionado and cartao_selecionado.pk == cartao.pk %} wallet-card-active{% endif %}" data-cartao-id="{{ cartao.pk }}" style="cursor:pointer; width:320px; max-width:320px; min-width:260px;">
              {% include 'core/_cartao_credito_card.html' with cartao=cartao limite_total=cartao.limite_total limite_utilizado=cartao.limite_utilizado limite_disponivel=cartao.limite_disponivel user=user %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    <div id="painel-cartao">
      {% include 'core/partials/cartoes_dashboard_painel.html' with fatura_id_selecionada=request.GET.fatura %}
    </div>
    <div class="d-flex justify-content-center mb-4">
        <a href="{% url 'core:cartao_credito_create' %}" class="btn btn-success btn-sm me-2"><i class="fas fa-plus me-1"></i>Novo Cartão</a>
        <a href="{% url 'core:cartao_credito_list' %}" class="btn btn-outline-primary btn-sm"><i class="fas fa-list me-1"></i>Gerenciar Cartões</a>
    </div>
    <div id="painel-despesas-grafico">
      {% include 'core/partials/despesas_fatura_painel.html' %}
    </div>
</div>

<script>
// Função para navegação dos cards de fatura
function setupFaturaNav(containerId, prevBtnId, nextBtnId, maxVisible) {
    const container = document.getElementById(containerId);
    const prevBtn = document.getElementById(prevBtnId);
    const nextBtn = document.getElementById(nextBtnId);
    if (!container) return;
    const cards = Array.from(container.children);
    let start = 0;
    function update() {
        cards.forEach((card, idx) => {
            card.style.display = (idx >= start && idx < start + maxVisible) ? '' : 'none';
        });
        prevBtn.style.display = start > 0 ? '' : 'none';
        nextBtn.style.display = (start + maxVisible < cards.length) ? '' : 'none';
    }
    prevBtn && prevBtn.addEventListener('click', () => { if (start > 0) { start--; update(); } });
    nextBtn && nextBtn.addEventListener('click', () => { if (start + maxVisible < cards.length) { start++; update(); } });
    update();
}

document.addEventListener('DOMContentLoaded', function() {
    setupFaturaNav('containerAberto', 'prevAberto', 'nextAberto', 4);
    setupFaturaNav('containerVencida', 'prevVencida', 'nextVencida', 4);
    setupFaturaNav('containerPaga', 'prevPaga', 'nextPaga', 4);
    // Carrossel estilo Google Wallet
    const walletCards = document.getElementById('walletCards');
    const cardContainers = Array.from(walletCards.children);
    let activeIdx = cardContainers.findIndex(c => c.querySelector('.wallet-card-active'));
    if (activeIdx === -1) activeIdx = 0;
    function updateWalletCarrossel() {
      const total = cardContainers.length;
      cardContainers.forEach((container, idx) => {
        const offset = idx - activeIdx;
        let z = 10 - Math.abs(offset);
        let scale = offset === 0 ? 1 : 0.85;
        let x = offset * 60;
        let blur = offset === 0 ? 'none' : 'blur(1.5px)';
        container.style.zIndex = z;
        container.style.transform = `translateX(${x}px) scale(${scale})`;
        container.style.filter = blur;
        container.style.opacity = Math.abs(offset) > 2 ? 0 : 1;
        container.style.pointerEvents = Math.abs(offset) > 2 ? 'none' : 'auto';
      });
    }
    updateWalletCarrossel();

    // Drag-to-scroll para o carrossel de cartões
    (function() {
      const walletCards = document.getElementById('walletCards');
      let isDown = false;
      let startX, scrollLeft, moved = false;
      walletCards.addEventListener('mousedown', (e) => {
        isDown = true;
        walletCards.classList.add('dragging');
        startX = e.pageX - walletCards.offsetLeft;
        scrollLeft = walletCards.scrollLeft;
        moved = false;
      });
      walletCards.addEventListener('mouseleave', () => {
        isDown = false;
        walletCards.classList.remove('dragging');
      });
      walletCards.addEventListener('mouseup', () => {
        isDown = false;
        walletCards.classList.remove('dragging');
      });
      walletCards.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - walletCards.offsetLeft;
        const walk = (x - startX) * 1.2; // Sensibilidade
        if (Math.abs(walk) > 5) moved = true;
        walletCards.scrollLeft = scrollLeft - walk;
      });
      // Prevenir seleção de cartão se houve arrasto
      cardContainers.forEach((container, idx) => {
        container.onclick = function() {
          const cardId = this.querySelector('.wallet-card').getAttribute('data-cartao-id');
          const params = new URLSearchParams(window.location.search);
          const selected = params.get('cartao') === String(cardId);
          if (selected) {
            params.delete('cartao');
            params.delete('fatura');
          } else {
            params.set('cartao', cardId);
            params.delete('fatura');
          }
          activeIdx = idx;
          cardContainers.forEach(c => c.querySelector('.wallet-card').classList.remove('wallet-card-active'));
          if (!selected) this.querySelector('.wallet-card').classList.add('wallet-card-active');
          updateWalletCarrossel();
          // Atualiza painel de faturas
          fetch('/cartoes_dashboard_ajax/?' + params.toString(), {headers: {'X-Requested-With': 'XMLHttpRequest'}})
            .then(resp => resp.json())
            .then(data => {
              document.getElementById('painel-cartao').innerHTML = data.html;
              history.pushState(null, '', '?' + params.toString());
              if (typeof setupFaturaNav === 'function') {
                setupFaturaNav('containerAberto', 'prevAberto', 'nextAberto', 4);
                setupFaturaNav('containerVencida', 'prevVencida', 'nextVencida', 4);
                setupFaturaNav('containerPaga', 'prevPaga', 'nextPaga', 4);
              }
              if (typeof renderLinhaChart === 'function') renderLinhaChart();
              // Após atualizar painel de faturas, atualiza painel de despesas/gráfico
              fetch('/despesas_fatura_ajax/?' + params.toString(), {headers: {'X-Requested-With': 'XMLHttpRequest'}})
                .then(resp2 => resp2.json())
                .then(data2 => {
                  document.getElementById('painel-despesas-grafico').innerHTML = data2.html;
                  setupFaturaCardClickAjax();
                });
            });
        };
      });
    })();
});

function setupFaturaCardClickAjax() {
    document.querySelectorAll('.fatura-card').forEach(card => {
        card.onclick = function(e) {
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A') return;
            const id = this.getAttribute('data-fatura-id');
            const params = new URLSearchParams(window.location.search);
            const selected = params.get('fatura') === String(id);
            if (selected) {
                params.delete('fatura');
            } else {
                params.set('fatura', id);
            }
            fetch('/despesas_fatura_ajax/?' + params.toString(), {headers: {'X-Requested-With': 'XMLHttpRequest'}})
                .then(resp => resp.json())
                .then(data => {
                    document.getElementById('painel-despesas-grafico').innerHTML = data.html;
                    history.pushState(null, '', '?' + params.toString());
                    setupFaturaCardClickAjax();
                });
        };
    });
}
document.addEventListener('DOMContentLoaded', function() {
    setupFaturaNav('containerAberto', 'prevAberto', 'nextAberto', 4);
    setupFaturaNav('containerVencida', 'prevVencida', 'nextVencida', 4);
    setupFaturaNav('containerPaga', 'prevPaga', 'nextPaga', 4);
    setupFaturaCardClickAjax();
});
</script>

<style>
.card, .card-body, .card.shadow, .card.h-100 {
    min-height: 220px;
    height: 100%;
}
.cartao-card {
    border-radius: 20px;
    box-shadow: 0 2px 8px #0002;
    border: 2px solid transparent;
}
.cartao-card-selecionado {
    border: 2px solid #007bff !important;
    box-shadow: 0 0 0 3px #007bff33 !important;
    background: #e9f5ff !important;
}
.fatura-card {
    border: 2px solid transparent;
}
.fatura-card.fatura-card-selecionada {
    border: 2px solid #007bff !important;
    box-shadow: 0 0 0 3px #007bff33 !important;
    background: #e9f5ff !important;
}
.fatura-card.fatura-card-selecionada.bg-success {
    border: 2px solid #28a745 !important;
    box-shadow: 0 0 0 3px #28a74533 !important;
    background: rgba(40, 167, 69, 0.1) !important;
}
.fatura-card.fatura-card-selecionada.bg-warning {
    border: 2px solid #ffc107 !important;
    box-shadow: 0 0 0 3px #ffc10733 !important;
    background: rgba(255, 193, 7, 0.1) !important;
}
.fatura-card.fatura-card-selecionada.bg-danger {
    border: 2px solid #dc3545 !important;
    box-shadow: 0 0 0 3px #dc354533 !important;
    background: rgba(220, 53, 69, 0.1) !important;
}
#legendaGastosCartoes.legenda-horizontal {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: center;
    gap: 10px;
    flex-wrap: nowrap;
    margin-top: 0;
    min-width: 110px;
    max-width: 150px;
}
#legendaGastosCartoes.legenda-horizontal span.legenda-item {
    display: flex;
    align-items: center;
    font-size: 1em;
    text-align: left;
    gap: 6px;
    white-space: nowrap;
    margin-bottom: 0;
}
#legendaGastosCartoes .legenda-cor {
    display: inline-block;
    width: 14px;
    height: 14px;
    border-radius: 3px;
    margin-right: 6px;
}
.wallet-carrossel { min-height: 220px; }
.wallet-cards { height: 220px; min-width: 100%; }
.wallet-card-container { top: 0; left: 50%; transform: translateX(-50%); }
.wallet-card { box-shadow: 0 4px 24px #0003; transition: box-shadow 0.3s, border 0.3s; border: 2px solid transparent; }
.wallet-card-active { box-shadow: 0 8px 32px #0005; border: 2px solid #007bff; }
</style>
{% endblock %} 